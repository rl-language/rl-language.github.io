

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The interactive inversion of control problem &mdash; rlc-doc 0.3.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=e259d695"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Where we are going and what RL will do once we get there." href="project_rationale.html" />
    <link rel="prev" title="Language Tour" href="language_tour.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            rlc-doc
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Concepts:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="language_tour.html">Language Tour</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">The interactive inversion of control problem</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#complex-interactive-subsystems">Complex interactive subsystems</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inversion-of-control">Inversion of control</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-problem">The problem</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-mental-burden">The mental burden</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#mitigations-coroutines">Mitigations: coroutines</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-limits-of-coroutines">The limits of coroutines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-core-limitation">The core limitation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reinforcement Learning Docs:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="project_rationale.html">Where we are going and what RL will do once we get there.</a></li>
<li class="toctree-l1"><a class="reference internal" href="rationale.html">The RL language rationale.</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial for reinforcement learning people</a></li>
<li class="toctree-l1"><a class="reference internal" href="gym_tutorial.html">RLC and GYM</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="language-reference.html">RLC Language Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="stdlib/index.html">stdlib</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">rlc-doc</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">The interactive inversion of control problem</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/the_inversion_of_control_problem.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="the-interactive-inversion-of-control-problem">
<h1>The interactive inversion of control problem<a class="headerlink" href="#the-interactive-inversion-of-control-problem" title="Link to this heading"></a></h1>
<p>When imperative <strong>complex interactive subsystems</strong> are subjected to <a class="reference external" href="https://en.wikipedia.org/wiki/Inversion_of_control">inversion of control</a> (<strong>IOC</strong>), they <a class="reference internal" href="#the-mental-burden"><span class="xref myst">become superlinearly harder</span></a> to reason about, refactor, and maintain. Imperative languages provide <a class="reference internal" href="#mitigations-coroutines"><span class="xref myst">solutions</span></a> to this problem, but when the complexity of the <strong>interactive subsystems</strong> increases, the probability of being able to use those features <a class="reference internal" href="#the-limits-of-coroutines"><span class="xref myst">decreases</span></a>.</p>
<p>Here are practical examples of real-world code that is hard to reason about, has inverted control, and is interactive.</p>
<ul class="simple">
<li><p>Blender’s stateful <a class="reference external" href="https://github.com/blender/blender/blob/main/source/blender/windowmanager/intern/wm_event_system.cc">user input event manager</a>. Because the event loop owns the timing of every mouse‑move, key‑press, and redraw, a small logic change (say, deferring key‑repeat) can subtly reorder callbacks. Reproducing a bug in similar <strong>scenarios may require replaying</strong> an entire input trace, and unit tests must mock dozens of event types to reach a single branch.</p></li>
<li><p>Anaconda installer’s stateful <a class="reference external" href="https://github.com/rhinstaller/anaconda/blob/main/pyanaconda/ui/gui/spokes/storage.py">UI pages</a>. The installer UI pages (spokes) can appear in any order depending on earlier answers. Tests that assert “if option X then page Y collects field Z” must replicate many permutations; a new optional component multiplies the permutation space, inflating test suites and increasing the risk of missed edge cases.</p></li>
<li><p>Google DeepMind’s <a class="reference external" href="https://github.com/google-deepmind/hanabi-learning-environment/tree/master/hanabi_learning_environment">Hanabi</a>. The game offers many possible player actions and must serialize state into tensors for neural‑network training. Performing local modifications to <strong>data structures</strong> can affect the surrounding classes, the tensor serialization code, and the order in which game actions execute—turning each change into a global problem.</p></li>
</ul>
<section id="complex-interactive-subsystems">
<h2>Complex interactive subsystems<a class="headerlink" href="#complex-interactive-subsystems" title="Link to this heading"></a></h2>
<p><strong>Complex interactive subsystems</strong> are subsystems that:</p>
<ul class="simple">
<li><p>must await input from some other component of the system before deciding how to proceed, <strong>and</strong> the user cares about their content (<strong>interactive</strong>). The source of input does not have to be a human; it can be anything, including randomness.</p></li>
<li><p>inputs change future states creating a graph of possible states, and the graph is large (<strong>complex</strong>).</p></li>
</ul>
<p>Examples:</p>
<div class="graphviz"><img src="_images/graphviz-77377c28510ff3a070aeb8f4b1a5070078154442.png" alt="digraph CheckoutFlow {
    node [shape=box, style=filled, fillcolor=lightgray];

    Start -&gt; CartReview;
    CartReview -&gt; Login [label=&quot;Not Logged In&quot;];
    CartReview -&gt; AddressSelection [label=&quot;Already Logged In&quot;, style=dotted];

    Login -&gt; AddressSelection;
    AddressSelection -&gt; ShippingMethod;
    ShippingMethod -&gt; PaymentMethod;
    PaymentMethod -&gt; OrderReview;
    OrderReview -&gt; ConfirmOrder;
    ConfirmOrder -&gt; ReceiptPage;

    // Back edges
    Login -&gt; CartReview [label=&quot;Back&quot;];
    AddressSelection -&gt; Login [label=&quot;Back&quot;];
    ShippingMethod -&gt; AddressSelection [label=&quot;Back&quot;];
    PaymentMethod -&gt; ShippingMethod [label=&quot;Back&quot;];
    OrderReview -&gt; PaymentMethod [label=&quot;Back&quot;];
    ConfirmOrder -&gt; OrderReview [label=&quot;Back&quot;];

    // Error and conditional states
    AddressSelection -&gt; InvalidAddress [label=&quot;Invalid&quot;, style=dashed];
    ShippingMethod -&gt; ShippingUnavailable [label=&quot;Unavailable&quot;, style=dashed];
    PaymentMethod -&gt; PaymentFailed [label=&quot;Invalid Card&quot;, style=dashed];
    ConfirmOrder -&gt; OrderFailed [label=&quot;Payment Error&quot;, style=dashed];

    // Grouping
    subgraph cluster_errors {
        style=dashed;
        color=red;
        label=&quot;Errors / Exceptions&quot;;
        InvalidAddress;
        ShippingUnavailable;
        PaymentFailed;
        OrderFailed;
    }

    subgraph cluster_flow {
        label=&quot;Main Checkout Flow&quot;;
        color=black;
        Start;
        CartReview;
        Login;
        AddressSelection;
        ShippingMethod;
        PaymentMethod;
        OrderReview;
        ConfirmOrder;
        ReceiptPage;
    }
}" class="graphviz" /></div>
<ul class="simple">
<li><p><strong>Webstore checkout page</strong>: when a user clicks on the payment mechanism of a web page, the pages they are shown depend on what they filled in on previous pages. Some pages are unique to certain payment circuits. If the user has specified they live in a different country, additional data may be requested. The user is allowed to navigate back to previous pages.</p></li>
<li><p><strong>Installer wizards</strong>: the user’s selection of components to install impacts the future pages they will be shown, as well as the additional data they are required to provide.</p></li>
<li><p><strong>Online governmental forms</strong>: the government does not care about your code quality. If they require a user to fill out 20 pages of forms where each page depends on the data entered in previous ones, that is how you must implement it.</p></li>
<li><p><strong>Video games</strong>: enemies in a first-person shooter have graph-like state machines describing states such as <code class="docutils literal notranslate"><span class="pre">running</span></code>, <code class="docutils literal notranslate"><span class="pre">shooting</span></code>, <code class="docutils literal notranslate"><span class="pre">falling</span></code>, driven by external events. Video games may contain hundreds of such state machines simultaneously, or individual machines with hundreds of states.</p></li>
</ul>
<p>Experienced programmers know that graphs should be avoided when unnecessary — but sometimes, they are mandatory. The previous examples all illustrate situations where the business logic <strong>requires</strong> the use of graphs in the design of your solution.</p>
</section>
<section id="inversion-of-control">
<h2>Inversion of control<a class="headerlink" href="#inversion-of-control" title="Link to this heading"></a></h2>
<p>The Wikipedia page on <a class="reference external" href="https://en.wikipedia.org/wiki/Inversion_of_control">inversion of control</a> describes the concept in sufficient detail, so I suggest reading it before continuing. As a recap: <strong>inversion of control</strong> arises when a program takes over the main loop of execution and relegates the programmer to implementing callbacks, which the main loop owner invokes according to its internal logic.</p>
<p>This pattern is pervasive and intentional. Graphics engines, web engines, reinforcement learning environments, and more all use it to decouple engine internals from business logic implementation. Inversion of control is not an issue itself, it is a extremely useful tool to decouple the programming plumbings from the business logic.</p>
</section>
<section id="the-problem">
<h2>The problem<a class="headerlink" href="#the-problem" title="Link to this heading"></a></h2>
<p>Let’s restate the problem:</p>
<ul class="simple">
<li><p>When <strong>complex interactive subsystems</strong> are subjected to <a class="reference external" href="https://en.wikipedia.org/wiki/Inversion_of_control">inversion of control</a>, they become superlinearly harder to reason about, refactor, and maintain.</p></li>
</ul>
<p>This assertion is based on the observation that giving up control of the main loop in an <strong>interactive system</strong> (complex or not) push the program to be implemented as a <a class="reference external" href="https://en.wikipedia.org/wiki/Automata-based_programming">state machine</a>, unless the programming language provides a mechanism to avoid it.</p>
<p>Let us consider an example: suppose we have a <strong>interactive subsystem</strong>, such as an implementation of Tic Tac Toe that owns the main loop. I will use python syntax, but what is relevant is not le language, but the need of writing is a state machine due to possible limitations with the language.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">play</span><span class="p">():</span>
    <span class="n">board</span> <span class="o">=</span> <span class="n">Board</span><span class="p">()</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">board</span><span class="o">.</span><span class="n">full</span><span class="p">():</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">query_some_input</span><span class="p">()</span>
        <span class="n">board</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">current_player</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">board</span><span class="o">.</span><span class="n">three_in_a_line</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">board</span><span class="o">.</span><span class="n">switch_current_player</span><span class="p">()</span>
</pre></div>
</div>
<p>What happens if the language does not have facilities like coroutines or similar constructs (as is the case in <code class="docutils literal notranslate"><span class="pre">C</span></code>), and we must give up control of the main loop to, say, a graphical engine?</p>
<p>The only viable implementation would be a class that can be updated at will by the graphical engine whenever the user clicks on a cell.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TicTacToe</span><span class="p">:</span>
  <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">Board</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">next_resumption_point</span> <span class="o">=</span> <span class="n">NormalTurn</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">current_player</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">three_in_a_line</span><span class="p">():</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">next_resumption_point</span> <span class="o">=</span> <span class="n">Ended</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">is_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_resumption_point</span> <span class="o">==</span> <span class="n">Ended</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Engine</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">():</span>
      <span class="n">game</span> <span class="o">=</span> <span class="n">TicTacToe</span><span class="p">()</span>
      <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
          <span class="n">inputs</span> <span class="o">=</span> <span class="n">poll_input</span><span class="p">()</span>
          <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">clicked_on_screen</span><span class="p">:</span>
            <span class="n">game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
          <span class="n">render_frame</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
</pre></div>
</div>
<p>This looked simple enough. Let us compose it into a more complex <strong>interactive sequence</strong>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># plays up to 2 times</span>
<span class="k">def</span><span class="w"> </span><span class="nf">play_twice</span><span class="p">():</span>
    <span class="n">game1</span> <span class="o">=</span> <span class="n">TicTacToe</span><span class="p">()</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">game1</span><span class="o">.</span><span class="n">is_done</span><span class="p">():</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">user_input</span>
        <span class="n">game1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="n">play_again</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">play_again</span><span class="p">:</span>
        <span class="n">game2</span> <span class="o">=</span> <span class="n">TicTacToe</span><span class="p">()</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">game2</span><span class="o">.</span><span class="n">is_done</span><span class="p">():</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">user_input</span>
            <span class="n">game2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>The class version is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PlayTwice</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game1</span> <span class="o">=</span> <span class="n">TicTacToe</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">=</span> <span class="n">Start</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">==</span> <span class="n">Start</span><span class="p">:</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">game1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">game1</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">is_done</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">=</span> <span class="n">Question</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">==</span> <span class="n">Question</span><span class="p">:</span>
            <span class="p">(</span><span class="n">play_again</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span>
            <span class="k">if</span> <span class="n">play_again</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">=</span> <span class="n">SecondGame</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">game2</span> <span class="o">=</span> <span class="n">TicTacToe</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">=</span> <span class="n">Ended</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">==</span> <span class="n">SecondGame</span><span class="p">:</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">game2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">game2</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">is_done</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">=</span> <span class="n">Ended</span>
            <span class="k">return</span>
</pre></div>
</div>
<p>As you can see, manually converting these functions into classes quickly results in very messy code.
As an exercise, convert the following piece of code into a class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># plays the game up to 4 times</span>
<span class="k">def</span><span class="w"> </span><span class="nf">play_four_times</span><span class="p">():</span>
    <span class="n">game1</span> <span class="o">=</span> <span class="n">PlayTwice</span><span class="p">()</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">game1</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">==</span> <span class="n">Ended</span><span class="p">:</span>
        <span class="n">game1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span>

    <span class="n">play_again</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">play_again</span><span class="p">:</span>
        <span class="n">game2</span> <span class="o">=</span> <span class="n">PlayTwice</span><span class="p">()</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">game2</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">==</span> <span class="n">Ended</span><span class="p">:</span>
            <span class="n">game2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span>
</pre></div>
</div>
<p>Hint, the graph representing the state is</p>
<div class="graphviz"><img src="_images/graphviz-47e5be03e6e8a6c96d96db2b416c60483ab205da.png" alt="digraph PlayFourTimes {
    node [shape=ellipse, style=filled, fillcolor=lightyellow];

    // States for first PlayTwice
    S0 [label=&quot;Start&quot;];
    G1 [label=&quot;Play Game 1&quot;];
    Q1 [label=&quot;Ask to Play Again?&quot;];
    G2 [label=&quot;Play Game 2&quot;];
    PT1_END [label=&quot;End of First PlayTwice&quot;];

    // Transition to second PlayTwice
    Q2 [label=&quot;Ask to Play Again?&quot;];
    G3 [label=&quot;Play Game 3&quot;];
    Q3 [label=&quot;Ask to Play Again?&quot;];
    G4 [label=&quot;Play Game 4&quot;];
    END [label=&quot;Final End&quot;];

    // First PlayTwice
    S0 -&gt; G1;
    G1 -&gt; Q1 [label=&quot;game1 complete&quot;];
    Q1 -&gt; G2 [label=&quot;yes&quot;];
    Q1 -&gt; PT1_END [label=&quot;no&quot;];
    G2 -&gt; PT1_END [label=&quot;game2 complete&quot;];

    // After First PlayTwice
    PT1_END -&gt; Q2;

    // Second PlayTwice (only if Q2 says yes)
    Q2 -&gt; G3 [label=&quot;yes&quot;];
    Q2 -&gt; END [label=&quot;no&quot;];

    G3 -&gt; Q3 [label=&quot;game3 complete&quot;];
    Q3 -&gt; G4 [label=&quot;yes&quot;];
    Q3 -&gt; END [label=&quot;no&quot;];
    G4 -&gt; END [label=&quot;game4 complete&quot;];
}" class="graphviz" /></div>
<section id="the-mental-burden">
<h3>The mental burden<a class="headerlink" href="#the-mental-burden" title="Link to this heading"></a></h3>
<p>I think it is intuitive to most programmers that this approach does not scale. Converting a function into a class is <em>syntactically</em> linear and follows a familiar “turn it into a state machine” recipe—but the real cost shows up later.</p>
<p>The <strong>superlinearity</strong> appears in maintenance. Each time you tweak the class‑based version, you must remember how the original imperative control flow was exploded into explicit states. A single new input or edge case can force you to revisit every branch that stores or resumes state. Concretely, if your program asks for <strong>k</strong> distinct inputs and you refactor it <strong>r</strong> times, the test‑case permutations can grow toward <strong>k × r</strong>—and that’s before you multiply by invalid or corner‑case inputs.</p>
<p>Sometimes <strong>k</strong> is small (e.g. Tic Tac Toe) or <strong>r</strong> is near 1 after initial authoring, so the pain stays minimal. But once either axis grows—say, a wizard with dozens of optional fields or a game with hundreds of enemy states—the maintenance burden balloons.</p>
<p>We are hardly the first to flag this. The issue is related—though not identical—to <a class="reference external" href="http://callbackhell.com">callback hell</a> and the classic pitfalls of <a class="reference external" href="https://en.wikipedia.org/wiki/Non-structured_programming">non‑structured programming</a>, because steering a large explicit state machine feels like hand‑coding the program counter with jumps. Non imperative programming models can sometime help, if the domain of the business logic maps well onto them. [<a class="reference external" href="https://en.wikipedia.org/wiki/Actor_model">1</a>] [<a class="reference external" href="https://en.wikipedia.org/wiki/Functional_reactive_programming">2</a>] [<a class="reference external" href="https://en.wikipedia.org/wiki/Structured_concurrency">3</a>]. Commenting on all of them is beyond the scope of the document, we will focus on the key imperative languages solution for the issue, coroutines.</p>
</section>
</section>
<section id="mitigations-coroutines">
<h2>Mitigations: coroutines<a class="headerlink" href="#mitigations-coroutines" title="Link to this heading"></a></h2>
<p>The most common solution to the problem is the use of asynchronous language features.
In particular, <a class="reference external" href="https://en.wikipedia.org/wiki/Coroutine">coroutines</a>—depending on their implementation—can sometimes fully solve the problem.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">play</span><span class="p">(</span><span class="n">board</span><span class="p">):</span>
  <span class="k">while</span> <span class="ow">not</span> <span class="n">board</span><span class="o">.</span><span class="n">full</span><span class="p">():</span>
    <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="k">yield</span><span class="p">()</span>
    <span class="n">board</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">current_player</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">board</span><span class="o">.</span><span class="n">three_in_a_line</span><span class="p">():</span>
      <span class="k">return</span>
    <span class="n">board</span><span class="o">.</span><span class="n">switch_current_player</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Engine</span><span class="p">:</span>
    <span class="o">...</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">():</span>
    <span class="n">board</span> <span class="o">=</span> <span class="n">Board</span><span class="p">()</span>
    <span class="n">game</span> <span class="o">=</span> <span class="n">play</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">poll_input</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">clicked_on_screen</span><span class="p">:</span>
        <span class="n">game</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="n">inputs</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
      <span class="n">render_frame</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
</pre></div>
</div>
<p>Indeed, coroutines do exactly what we did by hand. They turned the imperative code into something that could be stopped and started according to the logic of the main loop holder.</p>
</section>
<section id="the-limits-of-coroutines">
<h2>The limits of coroutines<a class="headerlink" href="#the-limits-of-coroutines" title="Link to this heading"></a></h2>
<p>Remember the second sentence in the original statement.</p>
<ul class="simple">
<li><p>Languages provide <a class="reference internal" href="#mitigations-coroutines"><span class="xref myst">solutions</span></a> to this problem (coroutines), but when the complexity of the <strong>interactive subsystems</strong> increases, the probability of being able to use those features decreases.</p></li>
</ul>
<p>Complexity here is intrinsic to the business rules: no amount of engineering can remove the six screens in Amazon’s checkout if management requires them. That complexity therefore lies outside the programmer’s control.</p>
<p>Each new rule, branch, or state transition is another chance that some part of the flow will demand a capability absent from the coroutine model. Once a single branch cannot be expressed, you sometimes can keep half the program in coroutines and the rest elsewhere—sometimes you must rewrite the entire interaction as an explicit class‑based state machine.</p>
<p><strong>Example</strong>:
You’ve implemented a user interface in Python using coroutines. It asks users for personal data—name, address, ID number, etc.—with the flow depending on their nationality.</p>
<p>Later, management introduces a new requirement:</p>
<blockquote>
<div><p>“At each screen transition, store the full application state so we can reload it later for debugging—<em>but without persisting any user data</em>, for privacy reasons.”</p>
</div></blockquote>
<p>This seemingly small request breaks the coroutine-based design.</p>
<p>CPython coroutines are normally not serializable. You can’t snapshot the coroutine’s execution state and restore it to be debugged elsewhere, and you can’t simply replay the coroutine from the beginning because you can’t store the sensitive user inputs. Without full serialization or replay, you lose the ability to recreate the interaction history—meaning the coroutine approach must be abandoned in favor of an explicit, inspectable, and serializable state machine.</p>
<section id="the-core-limitation">
<h3>The core limitation<a class="headerlink" href="#the-core-limitation" title="Link to this heading"></a></h3>
<p>The core limitation of coroutines in imperative languages is:</p>
<blockquote>
<div><p><strong>If a coroutine implementation is not fully equivalent to a class (or the equivalent construct of the language) in all essential respects, then any business requirement that demands a feature supported by classes—but not coroutines—forces you to abandon the coroutine design, at least locally around the affected logic.</strong></p>
</div></blockquote>
<p>Unfortunately, mainstream coroutine systems fall short. Most lack one or more capabilities that are standard in class-based designs. Here are some of the most common shortcomings (this list is not exhaustive):</p>
<ul class="simple">
<li><p><strong>No coroutine cloning</strong> — Not many imperative languages support copying a live coroutine. If your interactive program stores critical state inside a coroutine and you need to fork it—say, to run parallel simulations as in <a class="reference external" href="https://en.wikipedia.org/wiki/Monte_Carlo_tree_search">Monte Carlo Tree Search</a>—you’re out of luck. You must reimplement the logic using an explicit class that supports deep copying.</p></li>
<li><p><strong>No safe introspection</strong> — Many statically checked programming languages provide no portable way to inspect a coroutine’s internal state at runtime. Without access to that state, you cannot export it—for example, to a GPU in a reinforcement learning system—without resorting to fragile, non-portable hacks like leaking pointers or manually extracting values.</p></li>
<li><p><strong>Limited composition and reuse</strong> — Coroutines can often be composed and reused, but without delegating yields or similar constructs composing coroutines can become challenging.</p></li>
</ul>
<p>These issues aren’t theoretical. In traditional AI, for example, <strong>even a game as trivial as Tic-Tac-Toe cannot be implemented with coroutines</strong>—because the logic must support copying mid-execution to explore alternate futures of the game. If the coroutine holds the game’s variables instead just wrapping the game state, and you cannot clone it, you’re stuck. You could externalize all state to a separate object—but then you have a coroutine AND a state machine.</p>
<p>In practice, coroutines are excellent tools for managing the <em>plumbing</em> of large systems. But when applied to <strong>complex interactive subsystems</strong>, the model starts to crumble. As program complexity grows, so too does the probability that you’ll need to <strong>copy, inspect, serialize</strong>, or some other class related feature, and the probability trends higher.</p>
</section>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading"></a></h2>
<p>The <strong>interactive inversion of control problem</strong> is not going away. Graphics engines, web frameworks, reinforcement learning platforms, and countless other systems suffer deeply from it. While modern languages offer coroutine-based workarounds, they are <strong>fighting a losing battle</strong>. To make real progress, we need language-level constructs designed to express interactive, stateful logic in a first-class, inspectable, and composable way.</p>
<p><a class="reference internal" href="language_tour.html#action-functions"><span class="std std-ref">Rulebook</span></a> solves this issue through first-class continuations, under the name of Action functions.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="language_tour.html" class="btn btn-neutral float-left" title="Language Tour" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="project_rationale.html" class="btn btn-neutral float-right" title="Where we are going and what RL will do once we get there." accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Massimo Fioravanti.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>