

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The inversion of control problem &mdash; rlc-doc 0.3.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=e259d695"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Where we are going and what RL will do once we get there." href="project_rationale.html" />
    <link rel="prev" title="Rulebook documentation" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            rlc-doc
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Concepts:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">The inversion of control problem</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#complex-interactive-programs">Complex interactive programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inversion-of-control">Inversion of control</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-problem">The problem</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-mental-burden">The mental burden</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#mitigations-coroutines">Mitigations: coroutines</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-limits-of-coroutines">The limits of coroutines</a></li>
<li class="toctree-l2"><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reinforcement learning:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="project_rationale.html">Where we are going and what RL will do once we get there.</a></li>
<li class="toctree-l1"><a class="reference internal" href="rationale.html">The RL language rationale.</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial for reinforcement learning people</a></li>
<li class="toctree-l1"><a class="reference internal" href="gym_tutorial.html">RLC and GYM</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="language-reference.html">RLC Language Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="stdlib/index.html">stdlib</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">rlc-doc</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">The inversion of control problem</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/the_inversion_of_control_problem.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="the-inversion-of-control-problem">
<h1>The inversion of control problem<a class="headerlink" href="#the-inversion-of-control-problem" title="Link to this heading"></a></h1>
<p>When <strong>complex interactive programs</strong> are subjected to <a class="reference external" href="https://en.wikipedia.org/wiki/Inversion_of_control">inversion of control</a> (<strong>IOC</strong>), they <a class="reference internal" href="#the-mental-burden"><span class="xref myst">become superlinearly harder</span></a> to reason about, refactor, and maintain.</p>
<p>Here are practical examples of real-world code that became harder to reason about due to <strong>IOC</strong>:</p>
<ul class="simple">
<li><p>Blender’s stateful <a class="reference external" href="https://github.com/blender/blender/blob/main/source/blender/windowmanager/intern/wm_event_system.cc">GHOST event manager</a>. Because the event loop owns the timing of every mouse‑move, key‑press, and redraw, a small logic change (say, deferring key‑repeat) can subtly reorder callbacks. Reproducing a bug in similar <strong>scenarios may require replaying</strong> an entire input trace, and unit tests must mock dozens of event types to reach a single branch.</p></li>
<li><p>Anaconda installer’s stateful <a class="reference external" href="https://github.com/rhinstaller/anaconda/blob/main/pyanaconda/ui/gui/spokes/storage.py">UI pages</a>. The installer UI pages (spokes) can appear in any order depending on earlier answers. Tests that assert “if option X then page Y collects field Z” must replicate many permutations; a new optional component multiplies the permutation space, inflating test suites and increasing the risk of missed edge cases.</p></li>
<li><p>Google DeepMind’s <a class="reference external" href="https://github.com/google-deepmind/hanabi-learning-environment/tree/master/hanabi_learning_environment">Hanabi</a>. The game offers many possible player actions and must serialize state into tensors for neural‑network training. Performing local modifications to <strong>data structures</strong> can affect the surrounding classes, the tensor serialization code, and the order in which game actions execute—turning each change into a global problem.</p></li>
<li><p>LightZero’s 756-line implementation of <a class="reference external" href="https://github.com/opendilab/LightZero/blob/main/zoo/board_games/tictactoe/envs/tictactoe_env.py">Tic Tac Toe</a>.</p></li>
</ul>
<section id="complex-interactive-programs">
<h2>Complex interactive programs<a class="headerlink" href="#complex-interactive-programs" title="Link to this heading"></a></h2>
<p><strong>Complex interactive programs</strong> are programs that contain procedures with graph-like behavior and:</p>
<ul class="simple">
<li><p>the graph is large (<strong>complex</strong>),</p></li>
<li><p>they must await input from some other component of the system before deciding how to proceed, <strong>and</strong> the user cares about their content (<strong>interactive</strong>). The source of input does not have to be a human; it can be anything, including randomness.</p></li>
</ul>
<p>Examples:</p>
<div class="graphviz"><img src="_images/graphviz-77377c28510ff3a070aeb8f4b1a5070078154442.png" alt="digraph CheckoutFlow {
    node [shape=box, style=filled, fillcolor=lightgray];

    Start -&gt; CartReview;
    CartReview -&gt; Login [label=&quot;Not Logged In&quot;];
    CartReview -&gt; AddressSelection [label=&quot;Already Logged In&quot;, style=dotted];

    Login -&gt; AddressSelection;
    AddressSelection -&gt; ShippingMethod;
    ShippingMethod -&gt; PaymentMethod;
    PaymentMethod -&gt; OrderReview;
    OrderReview -&gt; ConfirmOrder;
    ConfirmOrder -&gt; ReceiptPage;

    // Back edges
    Login -&gt; CartReview [label=&quot;Back&quot;];
    AddressSelection -&gt; Login [label=&quot;Back&quot;];
    ShippingMethod -&gt; AddressSelection [label=&quot;Back&quot;];
    PaymentMethod -&gt; ShippingMethod [label=&quot;Back&quot;];
    OrderReview -&gt; PaymentMethod [label=&quot;Back&quot;];
    ConfirmOrder -&gt; OrderReview [label=&quot;Back&quot;];

    // Error and conditional states
    AddressSelection -&gt; InvalidAddress [label=&quot;Invalid&quot;, style=dashed];
    ShippingMethod -&gt; ShippingUnavailable [label=&quot;Unavailable&quot;, style=dashed];
    PaymentMethod -&gt; PaymentFailed [label=&quot;Invalid Card&quot;, style=dashed];
    ConfirmOrder -&gt; OrderFailed [label=&quot;Payment Error&quot;, style=dashed];

    // Grouping
    subgraph cluster_errors {
        style=dashed;
        color=red;
        label=&quot;Errors / Exceptions&quot;;
        InvalidAddress;
        ShippingUnavailable;
        PaymentFailed;
        OrderFailed;
    }

    subgraph cluster_flow {
        label=&quot;Main Checkout Flow&quot;;
        color=black;
        Start;
        CartReview;
        Login;
        AddressSelection;
        ShippingMethod;
        PaymentMethod;
        OrderReview;
        ConfirmOrder;
        ReceiptPage;
    }
}" class="graphviz" /></div>
<ul class="simple">
<li><p><strong>Webstore checkout page</strong>: when a user clicks on the payment mechanism of a web page, the pages they are shown depend on what they filled in on previous pages. Some pages are unique to certain payment circuits. If the user has specified they live in a different country, additional data may be requested. The user is allowed to navigate back to previous pages.</p></li>
<li><p><strong>Installer wizards</strong>: the user’s selection of components to install impacts the future pages they will be shown, as well as the additional data they are required to provide.</p></li>
<li><p><strong>Online governmental forms</strong>: the government does not care about your code quality. If they require a user to fill out 20 pages of forms where each page depends on the data entered in previous ones, that is how you must implement it.</p></li>
<li><p><strong>Video games</strong>: enemies in a first-person shooter have graph-like state machines describing states such as <code class="docutils literal notranslate"><span class="pre">running</span></code>, <code class="docutils literal notranslate"><span class="pre">shooting</span></code>, <code class="docutils literal notranslate"><span class="pre">falling</span></code>, driven by external events. Video games may contain hundreds of such state machines simultaneously, or individual machines with hundreds of states.</p></li>
</ul>
<p>Experienced programmers know that graphs should be avoided when unnecessary — but sometimes, they are mandatory. The previous examples all illustrate situations where the business logic <strong>requires</strong> the use of graphs in the design of your solution.</p>
</section>
<section id="inversion-of-control">
<h2>Inversion of control<a class="headerlink" href="#inversion-of-control" title="Link to this heading"></a></h2>
<p>The Wikipedia page on <a class="reference external" href="https://en.wikipedia.org/wiki/Inversion_of_control">inversion of control</a> describes the concept in sufficient detail, so I suggest reading it before continuing. As a recap: <strong>inversion of control</strong> arises when a program takes over the main loop of execution and relegates the programmer to implementing callbacks, which the main loop owner invokes according to its internal logic.</p>
<p>This pattern is pervasive and intentional. Graphics engines, web engines, reinforcement learning environments, and more all use it to decouple engine internals from business logic implementation.</p>
</section>
<section id="the-problem">
<h2>The problem<a class="headerlink" href="#the-problem" title="Link to this heading"></a></h2>
<p>Let’s restate the problem:</p>
<ul class="simple">
<li><p>When <strong>complex interactive programs</strong> are subjected to <a class="reference external" href="https://en.wikipedia.org/wiki/Inversion_of_control">inversion of control</a>, they become superlinearly harder to reason about, refactor, and maintain.</p></li>
</ul>
<p>This assertion is based on the observation that giving up control of the main loop in an <strong>interactive system</strong> (complex or not) effectively forces the program to be implemented as a <a class="reference external" href="https://en.wikipedia.org/wiki/Automata-based_programming">state machine</a>, unless the programming language provides a mechanism to avoid it.</p>
<p>Let us consider an example: suppose we have a Python <strong>interactive program</strong>, such as an implementation of Tic Tac Toe that owns the main loop.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">play</span><span class="p">():</span>
    <span class="n">board</span> <span class="o">=</span> <span class="n">Board</span><span class="p">()</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">board</span><span class="o">.</span><span class="n">full</span><span class="p">():</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">query_some_input</span><span class="p">()</span>
        <span class="n">board</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">current_player</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">board</span><span class="o">.</span><span class="n">three_in_a_line</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">board</span><span class="o">.</span><span class="n">switch_current_player</span><span class="p">()</span>
</pre></div>
</div>
<p>What happens if the language does not have facilities like coroutines or similar constructs (as is the case in <code class="docutils literal notranslate"><span class="pre">C</span></code>), and we must give up control of the main loop to, say, a graphical engine?</p>
<p>The only viable implementation would be a class that can be updated at will by the graphical engine whenever the user clicks on a cell.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TicTacToe</span><span class="p">:</span>
  <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">Board</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">next_resumption_point</span> <span class="o">=</span> <span class="n">NormalTurn</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">current_player</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">three_in_a_line</span><span class="p">():</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">next_resumption_point</span> <span class="o">==</span> <span class="n">Ended</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">is_done</span><span class="p">():</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_resumption_point</span> <span class="o">==</span> <span class="n">Ended</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Engine</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">():</span>
      <span class="n">game</span> <span class="o">=</span> <span class="n">TicTacToe</span><span class="p">()</span>
      <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
          <span class="n">inputs</span> <span class="o">=</span> <span class="n">poll_input</span><span class="p">()</span>
          <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">clicked_on_screen</span><span class="p">:</span>
            <span class="n">game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
          <span class="n">render_frame</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
</pre></div>
</div>
<p>This looked simple enough. Let us compose it into a more complex <strong>interactive sequence</strong>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># plays up to 2 times</span>
<span class="k">def</span><span class="w"> </span><span class="nf">play_twice</span><span class="p">():</span>
    <span class="n">game1</span> <span class="o">=</span> <span class="n">TicTacToe</span><span class="p">()</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">game1</span><span class="o">.</span><span class="n">is_done</span><span class="p">():</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">user_input</span>
        <span class="n">game1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="n">play_again</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">play_again</span><span class="p">:</span>
        <span class="n">game2</span> <span class="o">=</span> <span class="n">TicTacToe</span><span class="p">()</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">game2</span><span class="o">.</span><span class="n">is_done</span><span class="p">():</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">user_input</span>
            <span class="n">game2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>The class version is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PlayTwice</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game1</span> <span class="o">=</span> <span class="n">TicTacToe</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">=</span> <span class="n">Start</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">==</span> <span class="n">Start</span><span class="p">:</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">game1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">game1</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">is_done</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">=</span> <span class="n">Question</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">==</span> <span class="n">Question</span><span class="p">:</span>
            <span class="p">(</span><span class="n">play_again</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span>
            <span class="k">if</span> <span class="n">play_again</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">=</span> <span class="n">SecondGame</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">game2</span> <span class="o">=</span> <span class="n">TicTacToe</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">=</span> <span class="n">End</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">==</span> <span class="n">SecondGame</span><span class="p">:</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">game2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">game2</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">is_done</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">=</span> <span class="n">End</span>
            <span class="k">return</span>
</pre></div>
</div>
<p>As you can see, manually converting these functions into classes quickly results in very messy code.
As an exercise, convert the following piece of code into a class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># plays the game up to 4 times</span>
<span class="k">def</span><span class="w"> </span><span class="nf">play_four_times</span><span class="p">()</span>
    <span class="n">game1</span> <span class="o">=</span> <span class="n">PlayTwice</span><span class="p">()</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">game1</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">==</span> <span class="n">End</span><span class="p">:</span>
        <span class="n">game1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span>

    <span class="n">play_again</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">play_again</span><span class="p">:</span>
        <span class="n">game2</span> <span class="o">=</span> <span class="n">PlayTwice</span><span class="p">()</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">game2</span><span class="o">.</span><span class="n">resume_index</span> <span class="o">==</span> <span class="n">End</span><span class="p">:</span>
            <span class="n">game2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span>
</pre></div>
</div>
<p>Hint, the graph rappresenting the state is</p>
<div class="graphviz"><img src="_images/graphviz-47e5be03e6e8a6c96d96db2b416c60483ab205da.png" alt="digraph PlayFourTimes {
    node [shape=ellipse, style=filled, fillcolor=lightyellow];

    // States for first PlayTwice
    S0 [label=&quot;Start&quot;];
    G1 [label=&quot;Play Game 1&quot;];
    Q1 [label=&quot;Ask to Play Again?&quot;];
    G2 [label=&quot;Play Game 2&quot;];
    PT1_END [label=&quot;End of First PlayTwice&quot;];

    // Transition to second PlayTwice
    Q2 [label=&quot;Ask to Play Again?&quot;];
    G3 [label=&quot;Play Game 3&quot;];
    Q3 [label=&quot;Ask to Play Again?&quot;];
    G4 [label=&quot;Play Game 4&quot;];
    END [label=&quot;Final End&quot;];

    // First PlayTwice
    S0 -&gt; G1;
    G1 -&gt; Q1 [label=&quot;game1 complete&quot;];
    Q1 -&gt; G2 [label=&quot;yes&quot;];
    Q1 -&gt; PT1_END [label=&quot;no&quot;];
    G2 -&gt; PT1_END [label=&quot;game2 complete&quot;];

    // After First PlayTwice
    PT1_END -&gt; Q2;

    // Second PlayTwice (only if Q2 says yes)
    Q2 -&gt; G3 [label=&quot;yes&quot;];
    Q2 -&gt; END [label=&quot;no&quot;];

    G3 -&gt; Q3 [label=&quot;game3 complete&quot;];
    Q3 -&gt; G4 [label=&quot;yes&quot;];
    Q3 -&gt; END [label=&quot;no&quot;];
    G4 -&gt; END [label=&quot;game4 complete&quot;];
}" class="graphviz" /></div>
<section id="the-mental-burden">
<h3>The mental burden<a class="headerlink" href="#the-mental-burden" title="Link to this heading"></a></h3>
<p>I think it is intuitive to most programmers that this approach does not scale. Converting a function into a class is <em>syntactically</em> linear and follows a familiar “turn it into a state machine” recipe—but the real cost shows up later.</p>
<p>The <strong>superlinearity</strong> appears in maintenance. Each time you tweak the class‑based version, you must remember how the original imperative control flow was exploded into explicit states. A single new input or edge case can force you to revisit every branch that stores or resumes state. Concretely, if your program asks for <strong>k</strong> distinct inputs and you refactor it <strong>r</strong> times, the test‑case permutations can grow toward <strong>k × r</strong>—and that’s before you multiply by invalid or corner‑case inputs.</p>
<p>Sometimes <strong>k</strong> is small (e.g. Tic Tac Toe) or <strong>r</strong> is near 1 after initial authoring, so the pain stays minimal. But once either axis grows—say, a wizard with dozens of optional fields or a game with hundreds of enemy states—the maintenance burden balloons.</p>
<p>We are hardly the first to flag this. The issue is related—though not identical—to <a class="reference external" href="http://callbackhell.com">callback hell</a> and the classic pitfalls of <a class="reference external" href="https://en.wikipedia.org/wiki/Non-structured_programming">non‑structured programming</a>, because steering a large explicit state machine feels like hand‑coding the program counter with jumps.</p>
</section>
</section>
<section id="mitigations-coroutines">
<h2>Mitigations: coroutines<a class="headerlink" href="#mitigations-coroutines" title="Link to this heading"></a></h2>
<p>The most common solution to the problem is the use of asynchronous language features.
In particular, <a class="reference external" href="https://en.wikipedia.org/wiki/Coroutine">coroutines</a>—depending on their implementation—can sometimes fully solve the problem.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">play</span><span class="p">(</span><span class="n">board</span><span class="p">):</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">board</span><span class="o">.</span><span class="n">full</span><span class="p">():</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="k">yield</span><span class="p">()</span>
        <span class="n">board</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">current_player</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">board</span><span class="o">.</span><span class="n">three_in_a_line</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">board</span><span class="o">.</span><span class="n">switch_current_player</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Engine</span><span class="p">:</span>
    <span class="o">...</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">():</span>
    <span class="n">board</span> <span class="o">=</span> <span class="n">Board</span><span class="p">()</span>
    <span class="n">game</span> <span class="o">=</span> <span class="n">play</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">poll_input</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">clicked_on_screen</span><span class="p">:</span>
        <span class="n">game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
      <span class="n">render_frame</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
</pre></div>
</div>
<p>Indeed, coroutines do exactly what we did by hand. They turned the imperative code into something that could be stopped and started according to the logic of the main loop holder.</p>
</section>
<section id="the-limits-of-coroutines">
<h2>The limits of coroutines<a class="headerlink" href="#the-limits-of-coroutines" title="Link to this heading"></a></h2>
<p>Coroutines in type-checked languages are often less suited for <strong>complex interactive programs</strong>. dynamic languages, such as Python and JavaScript, can perform expensive introspection tricks to work around this. Still, every coroutine implementation I am aware of suffers from at least one of the following issues:</p>
<ul class="simple">
<li><p><strong>Cannot copy coroutines</strong> — Very few languages, such as scheme, can perform copies of ongoing coroutines.  This means that if you have an <strong>interactive program</strong> you wish to duplicate—say, a chess engine—the implementation must instead be a regular class. Copying is critical for techniques such as <a class="reference external" href="https://en.wikipedia.org/wiki/Monte_Carlo_tree_search">Monte Carlo Tree Search</a>.</p></li>
<li><p><strong>Cannot inspect the content of the coroutine</strong> — Most type-checked implementations, such as those in C++, do not allow inspection of a coroutine’s internal state without exfiltrating pointers to its variables, at least not in a protable way. Inspection is critical when the coroutine’s state influences a decision-maker—for example, in reinforcement learning, where you may want to send part of the coroutine’s state to the GPU to inform decisions.</p></li>
<li><p><strong>Cannot reuse coroutines</strong> — Most languages support coroutine reuse with stackful coroutine implementations, but some (like Lua or C++ before C++20, unless using Boost.Coroutine) do not. Reuse is essential when the size of the <strong>interactive program</strong> grows and you wish divide the problem into distict coroutines that solve subproblems.</p></li>
</ul>
<p>Notice that if you require any of these properties and your language does not support them, you are <strong>forced</strong> to implement the logic as a class—just like we did earlier—thus fully suffering from the <strong>inversion of control problem</strong>.</p>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading"></a></h2>
<p>The inversion‑of‑control pattern is not going away—graphics engines, web frameworks, RL platforms, and countless other systems deeply suffer from it.  What <em>can</em> change is the toolset we bring to the fight.  Ordinary coroutines already hint at a better world, yet their mainstream incarnations fall short when we need to</p>
<ul class="simple">
<li><p><strong>copy</strong> a running coroutine to explore alternate futures,</p></li>
<li><p><strong>inspect</strong> its frame to feed state into a learner or debugger, and</p></li>
<li><p><strong>reuse</strong> coroutines allowing problem decomposition.</p></li>
</ul>
<p>Without these three properties we slide back to hand‑rolled, class‑shaped state machines, inheriting the superlinear maintenance costs they impose.</p>
<p>ToDo, how to solve</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Rulebook documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="project_rationale.html" class="btn btn-neutral float-right" title="Where we are going and what RL will do once we get there." accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Massimo Fioravanti.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>